# Lightning Database

The Medialist uses a MySQL database for storing all data such as articles, user information, topics, bookmarks, etc. In
most cases, all a view is doing is simply fetching data from the database, serializing it into JSON and returning it to
the frontend - that can easily be emulated with some raw SQL and the server side part can be taken care of by Go's inbuilt
`net/http` package. But following the model-view-controller design, we should have "heavy" models and "light" controllers
so that's why the most important code from all of lightning is written inside of [`db.go`](../db.go).

All queries are prepared and executed by the [`db`](../db.go#16) variable that connects only once to the server thanks to
the [`getDB`](../db.go#L10) function. It prepares all queries and executes them. The queries are NOT actually hand written
rather they're generated by getting the query attribute of a QuerySet. For instance, in the case of getting an AuthToken
key from just a username, you can do this with Django's ORM - 

```python
>>> q = Token.objects.filter(user__username='mentix02').values_list('key')
>>> raw_query = str(q.query)
>>> print(raw_query)
SELECT `authtoken_token`.`key` FROM `authtoken_token` INNER JOIN `author_author` ON (`authtoken_token`.`user_id` = 
`author_author`.`id`) WHERE `author_author`.`username` = mentix02
```

That can be plopped inside the [`getTokenFromUsername`](../db.go#L93) method with just a difference of the last `WHERE`
clause as being replaced by a `?`. Then we can simply call the `QueryRow` function over the prepared statement (`Stmt`)
struct with the argument username as that's the only piece of data we need to provide. The SQL connector does the rest of
the work - if no results were found, we get an err - if there was a result, it's returned as a JSON response.

The [`db.go`](../db.go) is an important file and should ideally be the one where most of the source logic lives - the handers
can be good for validating input received from the client but for all database operations, [`db.go`](../db.go) should be
the one in control, not [`handlers.go`](../handlers.go). Heavy models, light controllers.
